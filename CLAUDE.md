# Polymarket Odds Arbitrage Bot

## 프로젝트 개요
전통 배팅사이트(Pinnacle)의 배당과 폴리마켓 예측 시장의 배당을 비교하여
배당 역전 현상이 발생한 경기를 자동 감지하고 폴리마켓에서 매수를 실행하는 봇.
맥 미니 로컬에서 24/7 운영. 기존 호가 불균형 봇(polymarket-bot)과 별도 프로젝트로 운영.

## 기존 봇과의 차이점

| 구분 | 기존 봇 (polymarket-bot) | 이 봇 (polymoly) |
|------|--------------------------|------------------------------|
| 진입 시점 | Live 경기 중 | 경기 시작 전 (1시간 전 마감) |
| 수익 근거 | 호가 불균형 가격 수렴 | 경기 결과 적중 |
| 보유 기간 | 수분~수십분 | 경기 종료까지 홀딩 |
| 손절 가능 여부 | 가능 | 불가능 (결과 나올 때까지) |
| 리스크 성격 | 유동성 리스크 | 결과 리스크 |
| 외부 데이터 | 폴리마켓 내부만 | Odds API (Pinnacle) 연동 |

## 개발 참고 문서(docs)
- docs/polymarket/* : polymarket 시장 조회 API 연동 및 사용법 문서
- docs/odds-api/overview.md : odds-api API 연동 및 사용법 문서

## 핵심 전략

### 전략 개요
전통 배팅사이트는 전문 오즈메이커가 수십 년 데이터 기반으로 배당을 설정함.
폴리마켓은 사람들의 호가로 움직이기 때문에 초기 설정이 비효율적일 수 있음.
이 갭을 감지하여 폴리마켓에서 저평가된 쪽을 매수하는 전략.

### 핵심 조건 (5가지 모두 충족해야 배팅)
```
조건 1: Pinnacle 배당 1.5 이하   → 실제 승리 확률 67% 이상인 강한 정배만
조건 2: 폴리마켓 현재가 50센트 미만 → 폴리마켓에서 역배 상태인 것만
조건 3: 갭 15센트 이상           → 수수료/마진 제거 후에도 기댓값 플러스
조건 4: 경기 시작 1시간 전까지   → 너무 늦으면 이미 가격 수렴
조건 5: 폴리마켓 유동성 Shares 50 이상 → 슬리피지 방지
```

### 왜 Pinnacle 1.5배당 이하인가
```
배당 1.5 이하 = 임플라이드 확률 67% 이상
→ Pinnacle 전문 오즈메이커가 67% 이상 확률로 판단한 팀
→ 승/패 중 확률이 높은 쪽에만 배팅해서 리스크 최소화
→ 폴리마켓에서 역배이면 낮은 가격에 살 수 있어 수익 극대화

배당 구간별 확률
1.1배당 → 91% (기회 거의 없음)
1.2배당 → 83%
1.3배당 → 77%
1.4배당 → 71%
1.5배당 → 67% ← 하한선
1.6배당 → 63% (이 아래는 배팅 안 함)
2.0배당 → 50% (동전 던지기 수준, 제외)
```

### 실제 기댓값 계산 예시
```
케이스 A (이상적인 케이스)
Pinnacle: 1.4배당 → 실제 확률 약 69%
폴리마켓: 45센트 (역배)
기댓값: 0.69 × 100 - 45 = +24센트 → 기댓값 +53%

케이스 B (최소 진입 케이스)
Pinnacle: 1.5배당 → 실제 확률 약 65%
폴리마켓: 50센트 (역배)
기댓값: 0.65 × 100 - 50 = +15센트 → 기댓값 +30%
```

### 핵심 전략 플로우
```
[1단계] Odds API로 Pinnacle NBA 예정 경기 배당 수집
        → 배당 1.5 이하인 경기만 필터링

[2단계] 폴리마켓에서 동일 경기 마켓 매핑
        (팀명 정규화 + 경기 시간 매칭으로 동일 경기 식별)

[3단계] 배당 역전 감지
        → Pinnacle 임플라이드 확률 - 폴리마켓 현재가 >= 15센트
        → 폴리마켓 현재가 50센트 미만인지 확인

[4단계] 유동성 필터
        → 폴리마켓 해당 마켓 Shares >= 50 확인

[5단계] 조건 모두 충족 시 폴리마켓 시장가 매수 실행
        → 갭 크기에 따라 베팅 금액 차등 적용
```

### 배당 변환 공식
```
임플라이드 확률(센트) = (1 / 배당) × 100
예) 1.5배당 → (1 / 1.5) × 100 = 67센트
    1.4배당 → (1 / 1.4) × 100 = 71센트
    1.3배당 → (1 / 1.3) × 100 = 77센트
```

## 대상 스포츠 및 리그

### 초기 런칭 대상 — 4개 종목 동시 운영

#### NBA (농구) — 메인
- 승/패 2가지 결과만 존재 (무승부 없음)
- 폴리마켓에서 가장 활성화된 스포츠 시장
- 기존 봇 인프라 활용 가능
- Odds API sport key: `basketball_nba`

#### 하키 (NHL)
- 승/패 2가지 결과만 존재 (연장/승부차기 포함 최종 결과 기준)
- 폴리마켓에서 NBA 다음으로 활성화된 스포츠 시장
- NBA와 동일한 로직 적용 가능
- Odds API sport key: `icehockey_nhl`

#### E스포츠
- 승/패 2가지 결과만 존재 (무승부 없음)
- 경기 빈도가 높아 기회 많음
- 폴리마켓 E스포츠 마켓 활성화 여부 사전 확인 필요
- Odds API sport key: `esports_*` (종목별 확인 필요)
- 주요 대상: League of Legends, CS2, Dota 2 등 주요 대회 중심

#### 축구 (핸디캡 한정)
- 일반 승/무/패(1X2) 배팅 제외 — 3가지 결과로 매핑 복잡
- **핸디캡(Asian Handicap) 배당만 비교** — 무승부 제거로 실질적 2가지 결과
  - 예) 팀A -1.5 핸디캡: 팀A가 2골 이상 차로 이겨야 적중
  - 핸디캡 라인이 0.5 단위 정수면 무승부 없음 → 이진 결과 보장
- 폴리마켓 축구 마켓이 핸디캡 형태로 구성되어 있는지 확인 필요
- Odds API markets: `asian_handicap` (별도 파라미터 사용)
- Odds API sport key: 주요 리그 우선 (`soccer_epl`, `soccer_spain_la_liga` 등)

### 2순위 — MLB (야구) — 추후 추가 예정
- 승/패 2가지 결과만 존재
- 시즌 중 매일 경기가 있어 기회 많음
- 초기 런칭 안정화 후 추가
- Odds API sport key: `baseball_mlb`

### 종목별 구현 차이점

| 종목 | 결과 구조 | Odds API market | 특이사항 |
|------|-----------|-----------------|----------|
| NBA | 승/패 | `h2h` | 기준 구현 |
| NHL | 승/패 | `h2h` | NBA와 동일 로직 |
| E스포츠 | 승/패 | `h2h` | 폴리마켓 마켓 활성도 확인 필요 |
| 축구 | 핸디캡 2결과 | `asian_handicap` | 0.5 단위 라인만 사용, 별도 매핑 로직 |

### 축구 핸디캡 배당 변환 공식
```
핸디캡 임플라이드 확률(센트) = (1 / 핸디캡 배당) × 100
예) -1.5 핸디캡 1.4배당 → (1 / 1.4) × 100 = 71센트

폴리마켓 매핑:
  "Will TeamA win by 2+ goals?" 형태의 마켓과 매핑
  핸디캡 라인 수치가 일치하는 마켓만 매핑
```

## 핵심 파라미터 (config.py에서 관리)

| 파라미터 | 값 | 설명 |
|---|---|---|
| 배팅 대상 | NBA 예정 경기 | Live 경기 제외, 경기 전만 |
| ODDS_PROVIDER | Pinnacle 단일 | 가장 정교한 오즈메이커 |
| MAX_PINNACLE_ODDS | 1.5 | Pinnacle 배당 상한선 (정배 기준) |
| MAX_POLYMARKET_PRICE | 0.50 | 폴리마켓 역배 기준 상한선 |
| GAP_THRESHOLD | 0.15 (15센트) | 배당 역전 감지 임계값 |
| BET_ENTRY_WINDOW_START | 경기 시작 24시간 전 | 모니터링 시작 시점 |
| BET_ENTRY_WINDOW_END | 경기 시작 1시간 전 | 배팅 마감 시점 |
| MIN_LIQUIDITY_SHARES | 50 | 폴리마켓 최소 유동성 |
| MAX_BET_USDC | $30 | 단일 베팅 최대 금액 |
| MIN_BET_USDC | $5 | 단일 베팅 최소 금액 |
| MAX_POSITIONS | 3 | 동시 최대 포지션 수 |

### 갭 크기별 베팅 금액
```
15~20센트 갭: $10~20 소액 매수
20~30센트 갭: $20~30 중간 매수
30센트 이상:  $30 최대 매수
```

### 손실 관리
```
경기 시작 후 손절 불가 → 경기 종료까지 홀딩
1경기 최대 베팅: 전체 자본의 10% 이하
동시 베팅: 최대 3경기
연속 3패 시: 자동 중단 후 전략 재검토
```

## Odds API 크레딧 관리

### 북메이커
Pinnacle 단일 사용. 배당 업계에서 가장 정교한 오즈메이커.
Pinnacle 배당 = 시장 컨센서스에 가장 가까운 실제 확률.

### 크레딧 소비 공식
```
크레딧 소비 = 경기 수 × 북메이커 수
NBA 경기 12개 × Pinnacle 1개 = 12 크레딧/호출
```

### 무료 플랜 (500 크레딧) — 테스트 전용
```
Day 1 (10회 호출, 120 크레딧): API 구조 파악
  - Response 데이터 구조 확인
  - Pinnacle 배당 형식 파악
  - 팀명/경기시간 형식 확인 (UTC 기준)

Day 2 (15회 호출, 180 크레딧): 매핑 로직 검증
  - 폴리마켓 경기명과 수동 비교
  - 팀명 정규화 로직 테스트
  - 배당 → 센트 변환 확인

Day 3 (15회 호출, 180 크레딧): 갭 감지 검증
  - Pinnacle 1.5 이하 경기 필터링 확인
  - 폴리마켓 역배 케이스 실제 발생 빈도 파악
  - 15센트 이상 갭 케이스 수집
  - 한 달 기준 배팅 기회가 몇 번이나 오는지 추정

총 소비: 약 480 크레딧 (여유분 20 크레딧)
```

### $30 플랜 (20,000 크레딧) — 실전 운영
```
경기 시작 24~6시간 전:  4시간마다 1회 (4회/경기)
경기 시작 6~2시간 전:   2시간마다 1회 (2회/경기)
경기 시작 2~1시간 전:   30분마다 1회 (2회/경기)
경기 시작 1시간 이내:   배팅 마감

경기당 총 호출: 8회 × 12 크레딧 = 96 크레딧/경기
하루 평균 7경기: 96 × 7 = 672 크레딧/일
한달 소비: 672 × 30 = 20,160 크레딧 (20,000 크레딧 내 운영 가능)
```

### 크레딧 절약 규칙
- 배팅이 이미 체결된 경기는 모니터링 목록에서 즉시 제거
- NBA 경기 없는 날은 호출 완전 스킵
- Pinnacle 배당 1.5 초과 경기는 조회 후 즉시 제외

## 경기 매핑 전략 (핵심 과제)

### 문제
```
Odds API:   "Los Angeles Lakers vs Boston Celtics"
폴리마켓:   "Will the Lakers beat the Celtics?"
```
팀명 형식이 달라서 자동 매핑 로직이 필요함.

### 매핑 접근 방식
1. 무료 플랜 테스트 중 실제 데이터 보면서 수동으로 패턴 파악
2. 팀명 정규화 딕셔너리 구축 (예: "Los Angeles Lakers" → "Lakers")
3. 경기 시간(UTC) 기준으로 최종 매칭 확인
4. 매핑 실패 시 해당 경기 스킵 (오매핑으로 인한 잘못된 베팅 방지)
5. team_mapping.json 파일로 별도 관리 (코드와 분리)

## 기술 스택
- Python 3.10+
- aiohttp (HTTP 요청)
- asyncio (비동기 처리)
- python-dotenv (환경변수)
- sqlite3 (포지션 및 배팅 기록)
- The Odds API (Pinnacle 배당 수집)
- py-clob-client (폴리마켓 매수 실행)

## API 정보
- Odds API: https://api.the-odds-api.com/v4/sports/basketball_nba/odds
- Gamma API: https://gamma-api.polymarket.com (폴리마켓 경기 조회)
- CLOB Base URL: https://clob.polymarket.com (폴리마켓 주문 실행)

## 파일 구조
```
polymoly/
├── CLAUDE.md
├── docs                 # 개발에 필요한 API docs(polymarket, odds-api)
├── main.py              # 진입점, 전체 루프 관리
├── config.py            # 환경변수 및 파라미터 설정
├── .env
├── requirements.txt
├── core/
│   ├── odds_fetcher.py  # Odds API 호출, Pinnacle 배당 수집
│   ├── matcher.py       # 경기 매핑 로직 (Odds API ↔ 폴리마켓)
│   ├── scanner.py       # 배당 역전 감지 엔진
│   ├── executor.py      # 폴리마켓 매수 실행
│   ├── monitor.py       # 포지션 모니터링 (경기 종료 후 정산 확인)
│   └── notifier.py      # 텔레그램 알림
├── data/
│   ├── positions.db     # SQLite 포지션 기록
│   └── team_mapping.json # 팀명 정규화 딕셔너리
└── logs/
    ├── bot.log
    └── error.log
```

## 환경변수 (.env)
```
POLYMARKET_PRIVATE_KEY=지갑_프라이빗키
ODDS_API_KEY=Odds_API_키
TELEGRAM_BOT_TOKEN=나중에_추가
TELEGRAM_CHAT_ID=나중에_추가
```

## 코딩 규칙
- 비동기(async/await) 패턴 일관되게 사용
- 환경변수는 .env에서만 관리, 하드코딩 금지
- 경기 매핑 실패 시 해당 경기 스킵 (오매핑으로 인한 잘못된 베팅 방지)
- 모든 베팅 결과는 SQLite에 기록 (경기 결과, 수익/손실 추적)
- 에러 발생 시 텔레그램 알림 + 로그 기록
- 민감 정보는 절대 하드코딩 금지

## 실행 방법
```bash
python main.py
```

## 개발 상태
- [x] CLAUDE.md 작성
- [x] 프로젝트 폴더 세팅
- [x] requirements.txt 세팅

### NBA / NHL / E스포츠 (h2h 로직 공통)
- [ ] Odds API 무료 플랜 테스트
  - [ ] NBA Response 데이터 구조 확인
  - [ ] NHL Response 데이터 구조 확인
  - [ ] E스포츠 Response 데이터 구조 확인 (sport key 목록 파악)
  - [ ] Pinnacle 배당 1.5 이하 필터링 확인
  - [ ] 팀명/경기시간 형식 확인 (종목별)
  - [ ] 갭 발생 빈도 수동 확인 (한달 기회 횟수 추정)
- [ ] 폴리마켓 예정 경기 조회 (종목별)
  - [ ] NBA: Gamma API tag_slug=nba
  - [ ] NHL: Gamma API tag_slug 확인 필요
  - [ ] E스포츠: Gamma API tag_slug 확인 필요
  - [ ] 경기명 형식 파악 (종목별)
- [ ] 경기 매핑 로직 검증 (core/matcher.py)
  - [ ] 팀명 정규화 딕셔너리 구축 (NHL, E스포츠 추가)
  - [ ] 경기 시간 기준 매칭 검증

### 축구 (핸디캡 전용 로직)
- [ ] Odds API 축구 asian_handicap 마켓 구조 파악
  - [ ] 핸디캡 라인 형식 확인 (예: -1.5, +0.5 등)
  - [ ] 0.5 단위 라인만 존재하는지 확인 (쿼터 라인 제외 필요)
- [ ] 폴리마켓 축구 마켓 구조 파악
  - [ ] 핸디캡 형태로 마켓이 구성되어 있는지 확인
  - [ ] 마켓 질문 형식 파악 (팀명 매핑 방법)
- [ ] 축구 전용 매핑 로직 구현 (matcher.py 확장)
  - [ ] 핸디캡 라인 수치 추출 + 매핑
  - [ ] 주요 리그 팀명 딕셔너리 구축

### 공통
- [ ] 배당 역전 감지 엔진 검증 (core/scanner.py)
  - [ ] 배당 → 센트 변환
  - [ ] MAX_PINNACLE_ODDS 필터 (1.5 이하만)
  - [ ] MAX_POLYMARKET_PRICE 필터 (50센트 미만만)
  - [ ] GAP_THRESHOLD 기반 역전 감지 (15센트 이상)
  - [ ] 유동성 필터 (Shares 50 이상)
- [ ] 매수 실행 검증 (core/executor.py)
  - [ ] 갭 크기별 베팅 금액 차등 적용
- [ ] 포지션 모니터링 (core/monitor.py)
  - [ ] 경기 종료 감지
  - [ ] 수익/손실 자동 기록
  - [ ] 연속 3패 시 자동 중단 로직
- [ ] 텔레그램 알림 (core/notifier.py)
- [ ] 크레딧 절약 로직 (모니터링 주기 자동 조절)
- [ ] $30 플랜 전환 후 실전 운영
- [ ] 안정화 후 MLB 추가 검토